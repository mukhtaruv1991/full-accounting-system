# دستور وخطة عمل مشروع نظام المحاسبة المتكامل (الإصدار 4.0)
*آخر تحديث: 23 سبتمبر 2025*

---
## 2. تفصيل حالة المراحل وخطة العمل

... (المراحل السابقة كما هي) ...

### 🟠 المرحلة 5: نظام المزامنة، الأمان، والبيانات المتقدم (قيد التنفيذ)
- **الحالة:** 15% مكتملة (تم بناء الأساس في الخادم)
- **الهدف:** بناء نظام بيئي متكامل وموثوق للعمل السحابي، والتعاوني، والنسخ الاحتياطي، مع نظام صلاحيات وسجل تدقيق صارم.
- **خطة العمل التفصيلية:**
  - **[✔️] بناء أساس الأمان والتدقيق في الخادم:**
    - **تم:** تعديل قاعدة البيانات (`schema.prisma`) لإضافة جداول `AuditLog`, `Role`, `Permission`.
    - **تم:** إنشاء "المراقب الذكي" (`audit.interceptor.ts`) لتسجيل العمليات تلقائياً.
  - **[ ] تفعيل سجل التدقيق ونظام الصلاحيات:**
    - **الخادم:** تطبيق `AuditInterceptor` على جميع الـ `Controllers` التي تحتاج إلى مراقبة.
    - **الخادم:** بناء `PermissionsGuard` للتحقق من صلاحيات المستخدم قبل تنفيذ أي عملية.
    - **الواجهة:** بناء واجهة رسومية للأدمن لإنشاء الأدوار (Roles) وتعيين الصلاحيات (Permissions) لكل دور.
  - **[ ] بناء خدمة المزامنة الذكية `SyncService.ts`:**
    - **المنطق:** بناء الخدمة التي تعمل في الخلفية لمزامنة البيانات الجديدة والمعدلة فقط بين `IndexedDB` والخادم.
    - **الذكاء:** الخدمة يجب أن تحترم صلاحيات المستخدم (لا تزامن بيانات لا يملك صلاحية رؤيتها).
    - **الواجهة:** بناء مؤشر حالة الاتصال والمزامنة في الشريط العلوي.
  - **[ ] بناء نظام النسخ الاحتياطي والتصدير:**
    - **نسخ احتياطي محلي:** إضافة وظيفة في الإعدادات لتصدير كامل قاعدة بيانات `IndexedDB` إلى ملف JSON وحفظه في ذاكرة الجهاز/الهاتف.
    - **نسخ احتياطي سحابي:** ربط التطبيق بواجهة Google Drive API للسماح للمستخدمين بحفظ نسخ احتياطية مشفرة على حساباتهم الخاصة.
    - **التصدير المرن:**
      - إضافة أزرار "تصدير" (PDF/Excel) في كل شاشات التقارير والكشوفات.
      - إضافة وظيفة "مشاركة" لتصدير البيانات الأولية (مثل قائمة العملاء) كملف CSV أو JSON ومشاركتها عبر تطبيقات أخرى.
