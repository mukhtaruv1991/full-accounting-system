name: Deploy to Render and Notify

on:
  push:
    branches:
      - main

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    secrets: inherit
    steps:
      - name: 1. Install jq
        run: sudo apt-get -y install jq

      - name: 2. Deploy and Notify
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_BACKEND_SERVICE_ID }}
          SERVICE_NAME: "Backend"
        run: |
          # 1. Trigger Deploy
          DEPLOY_RESPONSE=$(curl -s -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Accept: application/json" \
            -d '{}')

          DEPLOY_ID=$(echo "$DEPLOY_RESPONSE" | jq -r '.id')
          if [ "$DEPLOY_ID" = "null" ] || [ -z "$DEPLOY_ID" ]; then
            MSG="‚ùå $SERVICE_NAME deployment failed to start.\nResponse:\n$DEPLOY_RESPONSE"
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TELEGRAM_CHAT_ID" \
              -d "text=$MSG"
            exit 1
          fi

          # 2. Initial message
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=üöÄ $SERVICE_NAME deployment started.\nDeploy ID: $DEPLOY_ID"

          # 3. Polling loop for events
          LAST_EVENT_ID=""
          FINAL_STATUS=""
          while true; do
            sleep 20

            EVENTS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/deploys/$DEPLOY_ID/events")

            STATUS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$DEPLOY_ID" | jq -r '.status')

            # Get new events
            NEW_EVENTS=$(echo "$EVENTS" | jq -c '.[]' | while read e; do
              EID=$(echo "$e" | jq -r '.id')
              MSG=$(echo "$e" | jq -r '.message')
              if [[ "$EID" != "$LAST_EVENT_ID" ]]; then
                echo "$MSG"
                LAST_EVENT_ID=$EID
              fi
            done)

            if [ ! -z "$NEW_EVENTS" ]; then
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                -d "chat_id=$TELEGRAM_CHAT_ID" \
                -d "text=$(echo "$NEW_EVENTS" | sed 's/^/‚Ä¢ /')"
            fi

            if [[ "$STATUS" == "live" || "$STATUS" == "build_failed" || "$STATUS" == "deploy_failed" || "$STATUS" == "canceled" ]]; then
              FINAL_STATUS=$STATUS
              break
            fi
          done

          # 4. Final message
          if [ "$FINAL_STATUS" == "live" ]; then
            FINAL_MSG="‚úÖ $SERVICE_NAME deploy succeeded!"
          else
            FINAL_MSG="‚ùå $SERVICE_NAME deploy failed with status: $FINAL_STATUS"
          fi

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=$FINAL_MSG"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    secrets: inherit
    steps:
      - name: 1. Install jq
        run: sudo apt-get -y install jq

      - name: 2. Deploy and Notify
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_FRONTEND_SERVICE_ID }}
          SERVICE_NAME: "Frontend"
        run: |
          DEPLOY_RESPONSE=$(curl -s -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Accept: application/json" \
            -d '{}')

          DEPLOY_ID=$(echo "$DEPLOY_RESPONSE" | jq -r '.id')
          if [ "$DEPLOY_ID" = "null" ] || [ -z "$DEPLOY_ID" ]; then
            MSG="‚ùå $SERVICE_NAME deployment failed to start.\nResponse:\n$DEPLOY_RESPONSE"
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d "chat_id=$TELEGRAM_CHAT_ID" \
              -d "text=$MSG"
            exit 1
          fi

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=üöÄ $SERVICE_NAME deployment started.\nDeploy ID: $DEPLOY_ID"

          LAST_EVENT_ID=""
          FINAL_STATUS=""
          while true; do
            sleep 20
            EVENTS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/deploys/$DEPLOY_ID/events")

            STATUS=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
              "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$DEPLOY_ID" | jq -r '.status')

            NEW_EVENTS=$(echo "$EVENTS" | jq -c '.[]' | while read e; do
              EID=$(echo "$e" | jq -r '.id')
              MSG=$(echo "$e" | jq -r '.message')
              if [[ "$EID" != "$LAST_EVENT_ID" ]]; then
                echo "$MSG"
                LAST_EVENT_ID=$EID
              fi
            done)

            if [ ! -z "$NEW_EVENTS" ]; then
              curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                -d "chat_id=$TELEGRAM_CHAT_ID" \
                -d "text=$(echo "$NEW_EVENTS" | sed 's/^/‚Ä¢ /')"
            fi

            if [[ "$STATUS" == "live" || "$STATUS" == "build_failed" || "$STATUS" == "deploy_failed" || "$STATUS" == "canceled" ]]; then
              FINAL_STATUS=$STATUS
              break
            fi
          done

          if [ "$FINAL_STATUS" == "live" ]; then
            FINAL_MSG="‚úÖ $SERVICE_NAME deploy succeeded!"
          else
            FINAL_MSG="‚ùå $SERVICE_NAME deploy failed with status: $FINAL_STATUS"
          fi

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=$FINAL_MSG"
