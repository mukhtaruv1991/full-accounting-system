name: Deploy to Render and Notify

on:
  push:
    branches:
      - main

jobs:
  # --- JOB FOR BACKEND ---
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    steps:
      - name: 1. Install jq
        run: sudo apt-get -y install jq

      - name: 2. Trigger, Poll, and Notify
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_BACKEND_SERVICE_ID }}
          SERVICE_NAME: "Backend"
        run: |
          # --- Trigger ---
          deploy_id=$(curl -s -X POST -H "Authorization: Bearer $RENDER_API_KEY" -H "Accept: application/json" "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" | jq -r '.id')
          if [ -z "$deploy_id" ] || [ "$deploy_id" == "null" ]; then exit 1; fi
          
          # --- Poll ---
          final_status="unknown"
          for i in {1..60}; do
            status=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$deploy_id" | jq -r '.status')
            if [[ "$status" == "live" || "$status" == "build_failed" || "$status" == "deploy_failed" || "$status" == "canceled" ]]; then
              final_status=$status
              break
            fi
            sleep 10
          done
          
          # --- Notify ---
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          ACTION_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [ "$final_status" == "live" ]; then ICON="‚úÖ"; MESSAGE="üöÄ *Deploy Succeeded* for *$SERVICE_NAME*"; else ICON="‚ùå"; MESSAGE="üö® *Deploy Failed* for *$SERVICE_NAME* with status: \`$final_status\`"; fi
          TEXT="$ICON $MESSAGE%0A%0A*Commit:* [$SHORT_SHA](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})%0A*Logs:* [View Action]($ACTION_URL)"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" -d "chat_id=$TELEGRAM_CHAT_ID" -d "text=$TEXT" -d "parse_mode=Markdown"
          if [ "$final_status" != "live" ]; then exit 1; fi

  # --- JOB FOR FRONTEND ---
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    steps:
      - name: 1. Install jq
        run: sudo apt-get -y install jq

      - name: 2. Trigger, Poll, and Notify
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_FRONTEND_SERVICE_ID }}
          SERVICE_NAME: "Frontend"
        run: |
          # --- Trigger ---
          deploy_id=$(curl -s -X POST -H "Authorization: Bearer $RENDER_API_KEY" -H "Accept: application/json" "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" | jq -r '.id')
          if [ -z "$deploy_id" ] || [ "$deploy_id" == "null" ]; then exit 1; fi
          
          # --- Poll ---
          final_status="unknown"
          for i in {1..60}; do
            status=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys/$deploy_id" | jq -r '.status')
            if [[ "$status" == "live" || "$status" == "build_failed" || "$status" == "deploy_failed" || "$status" == "canceled" ]]; then
              final_status=$status
              break
            fi
            sleep 10
          done
          
          # --- Notify ---
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          ACTION_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [ "$final_status" == "live" ]; then ICON="‚úÖ"; MESSAGE="üöÄ *Deploy Succeeded* for *$SERVICE_NAME*"; else ICON="‚ùå"; MESSAGE="üö® *Deploy Failed* for *$SERVICE_NAME* with status: \`$final_status\`"; fi
          TEXT="$ICON $MESSAGE%0A%0A*Commit:* [$SHORT_SHA](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})%0A*Logs:* [View Action]($ACTION_URL)"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" -d "chat_id=$TELEGRAM_CHAT_ID" -d "text=$TEXT" -d "parse_mode=Markdown"
          if [ "$final_status" != "live" ]; then exit 1; fi
